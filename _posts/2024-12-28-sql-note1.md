---
layout: post
title: "Play with SQL Query (Basic&Intermediate)"
date: 2024-12-28 17:28:30 +0100
categories: SQL DATABASE
tags: adventure
---

Before writing any SQL (or indeed, any other language) query to retrieve data, the first step is to figure out the desired data.   
That's a broad topic that I won't talk about in this post üò£.   
However it's crucial to keep this mindset from the very beginning: know exactly what we want.  

---

# Navigation ‚¨áÔ∏è
- [The Order Matter: SELECT comes after the others...](#the-order-matter-select-comes-after-the-others)
- ['GROUP BY' Or 'Window Function'?](#group-by-or-window-function)
- [Deal With Complex String: Regular Expression Functions](#deal-with-complex-string-regular-expression-functions)

---

# The Order Matter: SELECT comes after the others... {#the-order-matter-select-comes-after-the-others}

This section will be focusing on the order of execution for SQL commands.   

A common basic SQL query typically follows this structures:
```SQL
SELECT *
FROM table
WHERE ...
GROUP BY ...
HAVING ...
ORDER BY ...;
```
  
The computer process this query in the following order:
1. **FROM**: Access the specific **table**;
2. **WHERE**: Apply filters to retrieve relevant **rows**;
3. **GROUP BY**: Group the **rows** retrieved in step 2;
4. **HAVING**: Apply filters to the **groups of rows** formed in step 3;
5. ***SELECT***: Decide which **columns** will be retrieved;
6. **ORDER BY**: order the **retrieved data**.

Notably, the SELECT command is executed **after** WHERE, GROUP BY, and HAVING.   
  
Therefore, when advanced queries are involved in the SELECT command, such as [Window Functions](#group-by-or-window-function), they are only applied **after** the WHERE, GROUP BY, and HAVING commands have been processed.   
That is, **we cannot filter table based on columns generated by Window Functions we involved in the SELECT section.**

Generally, **to achieve this, we have to create a table using Common Table Expression(CTE) to storage the new columns created.** We can then filter data based on them.    

This advanced SQL query with **CTE** will follow this structures:
```SQL
-- start with the CTE command
WITH new_table AS ( 
    SELECT 
        *,
        DENSE_RANK() OVER (PARTITION BY a ORDER BY b) as rn -- window function
    FROM
        table
)
SELECT *
FROM new_table
WHERE rn = 1 -- filter based on rn created by window function
GROUP BY ...
HAVING ...
ORDER BY ...;
```

---

# 'GROUP BY' Or 'Window Function'? {#group-by-or-window-function} 

Window functions:
1. **can not** be involved in: WHERE, GROUP BY, and HAVING.
2. **can** be involved in: SELECT, ORDER BY.
 




---

# Deal With Complex String: Regular Expression Functions {#deal-with-complex-string-regular-expression-functions}

Love it‚ô•Ô∏è‚ô•Ô∏è‚ô•Ô∏è.  
They are super powerful in dealing with complex string.   

Regex:
1. **can not** be involved in: None.
2. **can** be involved in: SELECT,WHERE, GROUP BY, HAVING, ORDER BY.   
 
Below are some commonly used functions with example for illustration.

1. **Matches character within a string: REGEXP**

    This is a commonly used basic regular expression function.    
    Use it when you want to check if any data in a specific column match the *pattern* you set.

    Metacharacters demonstration:
    - string **begin** with 'a': put **^** at the beginning
    ```SQL
    SELECT *
    FROM table
    WHERE column REGEXP '^a';
    ```
    - string **end** with 'a': put **$** at the end
    ```SQL
    SELECT *
    FROM table
    WHERE column REGEXP 'a$';
    ```
    - string **contain** 'a' or 'b': put **|** in between
    ```SQL
    SELECT *
    FROM table
    WHERE column REGEXP 'a|b';
    ```
    - string **contain** any of 'a''c''g': put character inside **[]**
    ```SQL
    SELECT *
    FROM table
    WHERE column REGEXP '[acg]';
    ```
    - string **contain** any from a to g: put character inside **[-]**
    ```SQL
    SELECT *
    FROM table
    WHERE column REGEXP '[a-g]';
    ```
    - string **contain** a specific amount of characters: 
        - contain a specific amount
            - put specific amount of **.** in between **^** and **$**
                ```SQL
                SELECT *
                FROM table
                WHERE column REGEXP '^......$'; -- in this case 6 characters
                ```
            - or a more simple and clear version: put the amount inside the **{}** and put it behind **.**
                ```SQL
                SELECT *
                FROM table
                WHERE column REGEXP '^.{6}$'; -- in this case 6 characters
                ```
        - contain any amount (could be zero or more)
            ```SQL
            SELECT *
            FROM table
            WHERE column REGEXP '^.*$'; -- * represent any amount
            ```
    - string/substring **begin** with "a" following by "b": put **(?=b)** behind a
    ```SQL
    SELECT *
    FROM table
    WHERE column REGEXP 'a(?=b)';
    ```
    - string/substring with "a" following "b": put **(?<=b)** before a
    ```SQL
    SELECT *
    FROM table
    WHERE column REGEXP '(?<=b)a'; -- see ? as follow and < represent backward
    ``` 
    - use **()** to seperate metacharacter if you involve a lot of conditions
    ```SQL
    SELECT *
    FROM table
    WHERE column REGEXP '^(a|b).*(c|d)$'; -- any substring that start with a or b, and end with c or d
    ```


2. **Split a column with string** in the form of "a,b,c,d,e" or anything like that:
    ```SQL
    SELECT
        *,
        regexp_split_to_table(column_to_split, ',') AS split_column
        -- column_to_split: replace with the column you want to split
        -- ',': replace with the delimiter used in the column
    FROM
        table
```











# **Reference**
[snowflake_SQL_Documentation](https://docs.snowflake.com/en/reference)
[w3resource_mySQL_REGEXP_Function](https://www.w3resource.com/mysql/string-functions/mysql-regexp-function.php)